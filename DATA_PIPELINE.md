# Data Pipeline: Model Data ‚Üí API ‚Üí UI

This document traces the complete data flow from model predictions to UI display.

---

## üìä **PIPELINE 1: STATS DATA (Model Comparison & Uncertainty Analysis)**

### **Step 1: Data Source (CSV File)**
- **Location**: `data/processed/songs_with_predictions.csv`
- **Required Columns** (always present when file is created):
  - `audio_prediction` (values: "happy", "chill", "sad", "hyped" - lowercase) - **REQUIRED by API**
  - `lyrics_prediction` (values: "happy", "chill", "sad", "hyped" - lowercase) - **REQUIRED by API**
  - `audio_confidence` (float, 0-1) - **Always created by script**, used for low confidence stats and confidence distribution
  - `lyrics_confidence` (float, 0-1) - **Always created by script**, used for low confidence stats and confidence distribution
- **How it's created**: Generated by running `src/run_lyrics_comparison.py`
  - **Prerequisites** (must exist before running):
    1. Input dataset: `data/processed/songs_mapped_20k_balanced.csv` (or similar dataset with audio features and lyrics)
    2. Trained model: `models/new_song_mood_model.joblib`
    3. Dataset must have:
       - Audio features (tempo, energy, valence, etc.) for audio predictions
       - Lyrics column (default: `text`, or `lyrics`, `Lyrics`, `Text`, `song_text`)
  - **Script process**:
    1. Loads dataset from `songs_mapped_20k_balanced.csv`
    2. Loads audio model and gets predictions ‚Üí adds `audio_prediction` and `audio_confidence`
    3. Uses `FreeLyricsClassifier` (VADER) ‚Üí adds `lyrics_prediction` and `lyrics_confidence`
    4. Saves to `data/processed/songs_with_predictions.csv`
  - **Note**: The API will work with just `audio_prediction` and `lyrics_prediction` columns, but confidence columns are always created by the script and enable additional statistics

### **Step 2: API Server - `/api/stats` Endpoint**
**File**: `src/api_server.py` (lines 72-189)

**Process**:
1. **Load CSV** (line 99):
   ```python
   df = pd.read_csv(predictions_file)
   ```

2. **Calculate Agreement** (lines 112-114):
   - Counts where `audio_prediction == lyrics_prediction`
   - Calculates percentage: `(agree_count / total) * 100`

3. **Calculate Distribution** (lines 117-127):
   - Gets percentage distribution for each mood (happy, chill, sad, hyped)
   - Separate counts for audio and lyrics models
   - Output format:
     ```json
     [
       {"mood": "Happy", "audio": 25.5, "lyrics": 30.2},
       {"mood": "Chill", "audio": 20.1, "lyrics": 18.5},
       ...
     ]
     ```

4. **Calculate Confusion Matrix** (lines 129-139):
   - Cross-tabulation: audio mood vs lyrics mood
   - Output format:
     ```json
     [
       {"audio": "Happy", "happy": 100, "chill": 20, "sad": 5, "hyped": 10},
       {"audio": "Chill", "happy": 15, "chill": 80, "sad": 25, "hyped": 5},
       ...
     ]
     ```

5. **Calculate Low Confidence Stats** (lines 142-158):
   - **Only calculated if** `audio_confidence` and `lyrics_confidence` columns exist (line 143)
   - For each mood, calculates % of predictions with low confidence
   - Thresholds: audio < 0.35, lyrics < 0.6
   - **Note**: If confidence columns are missing, this section is skipped (returns empty array)

6. **Calculate Confidence Distribution** (lines 161-171):
   - **Only calculated if** `audio_confidence` and `lyrics_confidence` columns exist (line 162)
   - Bins confidence scores into ranges: 0-0.2, 0.2-0.4, 0.4-0.6, 0.6-0.8, 0.8-1.0
   - Counts for each bin
   - **Note**: If confidence columns are missing, this section is skipped (returns empty array)

7. **Return JSON** (lines 173-183):
   ```json
   {
     "agreement": {"agree": 65.5, "disagree": 34.5, "total": 10000},
     "distribution": [...],
     "confusion": [...],
     "lowConfidence": [...],
     "confidenceDistribution": [...]
   }
   ```

### **Step 3: Frontend - Inline Script (Initial Fetch)**
**File**: `UI/app/layout.tsx` (lines 42-146)

**Process**:
1. **Runs on DOMContentLoaded** (line 70)
2. **Fetches from API** (lines 78-84):
   ```javascript
   fetch('http://localhost:8000/api/stats')
     .then(res => res.json())
     .then(data => {
       window.__API_DATA__.stats = data;
       notifyListeners('stats', data);
     })
   ```
3. **Stores in global** (line 49): `window.__API_DATA__.stats`
4. **Dispatches event** (line 66): `api-stats-loaded` custom event
5. **Sets data attribute** (line 117): `document.body.setAttribute('data-api-stats', JSON.stringify(data))`

### **Step 4: Frontend - React Component Receives Data**
**File**: `UI/components/model-comparison.tsx`

**Process**:
1. **Component Mounts** (line 49):
   - `useEffect` runs when component first renders

2. **Registers Listener** (lines 141-144):
   ```typescript
   if (window.__registerAPIListener__) {
     window.__registerAPIListener__(handleData)
   }
   ```

3. **Listens for Event** (line 150):
   ```typescript
   window.addEventListener('api-stats-loaded', handleEvent)
   ```

4. **Checks Data Attribute** (lines 52-87):
   - Reads `document.body.getAttribute('data-api-stats')`
   - Parses JSON if found

5. **Polls Global Store** (lines 196-203):
   - Checks `window.__API_DATA__.stats` every 500ms

6. **Processes Data** (lines 109-137):
   - **Agreement Data**: Converts to pie chart format
     ```typescript
     [
       { name: "Agree", value: data.agreement.agree, color: "..." },
       { name: "Disagree", value: data.agreement.disagree, color: "..." }
     ]
     ```
   - **Distribution Data**: Uses directly (already in correct format)
   - **Confusion Data**: Maps to chart format
     ```typescript
     data.confusion.map(row => ({
       audio: row.audio,
       happy: row.happy || 0,
       chill: row.chill || 0,
       sad: row.sad || 0,
       hyped: row.hyped || 0
     }))
     ```

7. **Updates State** (lines 114-136):
   - `setAgreementData(...)`
   - `setDistributionData(...)`
   - `setConfusionData(...)`
   - `setLoading(false)`

### **Step 5: UI Rendering**
**File**: `UI/components/model-comparison.tsx` (lines 250-404)

**Process**:
1. **Conditional Rendering** (line 250):
   ```typescript
   if (loading) return <div>Loading...</div>
   if (error) return <div>Error: {error}</div>
   ```

2. **Pie Chart** (lines 260-280):
   - Uses `agreementData` with Recharts `PieChart` component

3. **Bar Chart** (lines 290-320):
   - Uses `distributionData` with Recharts `BarChart` component

4. **Heatmap** (lines 330-370):
   - Uses `confusionData` with Recharts `BarChart` component

---

## üéµ **PIPELINE 2: PREDICT ENDPOINT (User Song Prediction)**

### **Step 1: User Input**
**File**: `UI/components/prediction-interface.tsx` (line 193)

- User types song name in input field
- Clicks "Predict" button (line 197)

### **Step 2: Frontend - API Call**
**File**: `UI/components/prediction-interface.tsx` (lines 77-179)

**Process**:
1. **Button Click Handler** (line 197):
   ```typescript
   onClick={(e) => {
     e.preventDefault()
     handleSearch()
   }}
   ```

2. **Parse Input** (lines 86-100):
   - Extracts song name and optional artist
   - Format: "Song Name" or "Song Name by Artist"

3. **Make API Call** (lines 106-116):
   ```typescript
   fetch('http://localhost:8000/api/predict', {
     method: 'POST',
     headers: { 'Content-Type': 'application/json' },
     body: JSON.stringify({
       song: songName,
       artist: artistName
     })
   })
   ```

### **Step 3: API Server - `/api/predict` Endpoint**
**File**: `src/api_server.py` (lines 249-389)

**Process**:
1. **Receive Request** (line 285):
   ```python
   data = request.json  # {song: "...", artist: "..."}
   ```

2. **Find Song in Dataset** (lines 296-307):
   - Calls `find_song_in_dataset(song_name, artist_name)` (line 391)
   - Searches CSV files for matching song
   - Returns audio features dict if found

3. **Get Audio Prediction** (lines 314-343):
   - Loads audio model (line 32): `models/new_song_mood_model.joblib`
   - Prepares features DataFrame (lines 319-321)
   - Calls `get_audio_predictions(df, model_data)` (line 324)
   - Returns: `{mood: "happy", confidence: 0.82, lowConfidence: false}`

4. **Get Lyrics** (lines 309-312):
   - Calls `find_lyrics_in_dataset(song_name, artist_name)` (line 477)
   - Searches CSV files for lyrics text

5. **Get Lyrics Prediction** (lines 347-360):
   - Uses `FreeLyricsClassifier` (VADER sentiment analysis)
   - Returns: `{mood: "happy", confidence: 0.91, lowConfidence: false}`

6. **Check Agreement** (lines 362-368):
   - Compares audio mood vs lyrics mood

7. **Return Response** (lines 370-383):
   ```json
   {
     "song": "Happy",
     "artist": "Pharrell Williams",
     "audio": {
       "mood": "happy",
       "confidence": 0.82,
       "lowConfidence": false
     },
     "lyrics": {
       "mood": "happy",
       "confidence": 0.91,
       "lowConfidence": false
     },
     "agree": true
   }
   ```

### **Step 4: Frontend - Process Response**
**File**: `UI/components/prediction-interface.tsx` (lines 125-164)

**Process**:
1. **Parse Response** (line 125):
   ```typescript
   const data = await response.json()
   ```

2. **Convert to Component Format** (lines 128-143):
   ```typescript
   setSelectedSong({
     song: data.song,
     artist: data.artist,
     audio: {
       mood: data.audio.mood,
       confidence: data.audio.confidence,
       lowConfidence: data.audio.lowConfidence
     },
     lyrics: {
       mood: data.lyrics.mood,
       confidence: data.lyrics.confidence,
       lowConfidence: data.lyrics.lowConfidence
     },
     agree: data.agree
   })
   ```

### **Step 5: UI Rendering**
**File**: `UI/components/prediction-interface.tsx` (lines 209-333)

**Process**:
1. **Conditional Display** (line 209):
   ```typescript
   {selectedSong && (
     <Card>...</Card>
   )}
   ```

2. **Display Predictions** (lines 220-280):
   - Shows audio mood badge with confidence
   - Shows lyrics mood badge with confidence
   - Shows agreement indicator

---

## üìà **PIPELINE 3: DATASET DATA (Dataset Explorer)**

### **Step 1: Data Source (CSV File)**
- **Location**: `data/processed/songs_mapped_20k_balanced.csv` (or similar)
- **Required Column**: `mood` (values: "happy", "chill", "sad", "hyped")

### **Step 2: API Server - `/api/dataset` Endpoint**
**File**: `src/api_server.py` (lines 191-247)

**Process**:
1. **Load CSV** (line 216):
   ```python
   df = pd.read_csv(dataset_file, nrows=100000)
   ```

2. **Calculate Distribution** (lines 224-236):
   - Counts occurrences of each mood
   - Calculates percentages
   - Output format:
     ```json
     {
       "total": 100000,
       "distribution": [
         {"mood": "Happy", "count": 25000, "percentage": 25.0},
         {"mood": "Chill", "count": 25000, "percentage": 25.0},
         {"mood": "Sad", "count": 25000, "percentage": 25.0},
         {"mood": "Hyped", "count": 25000, "percentage": 25.0}
       ]
     }
     ```

### **Step 3: Frontend - Inline Script**
**File**: `UI/app/layout.tsx` (lines 86-93)

- Same pattern as stats: fetches, stores in `window.__API_DATA__.dataset`, dispatches event

### **Step 4: Frontend - React Component**
**File**: `UI/components/dataset-explorer.tsx`

- Same pattern as model-comparison: registers listener, listens for event, checks data attribute, polls global store
- Processes data (lines 27-37): Maps to chart format with colors
- Updates state: `setDatasetDistribution(...)`, `setTotal(...)`

### **Step 5: UI Rendering**
- Bar chart showing mood distribution

---

## üîç **DEBUGGING CHECKLIST**

Use this to identify where the pipeline breaks:

### **For Stats Data:**
- [ ] **Step 1**: Does `data/processed/songs_with_predictions.csv` exist?
  - Check: `ls data/processed/songs_with_predictions.csv` (or `dir data\processed\songs_with_predictions.csv` on Windows)
  - **If missing**: Run `python src/run_lyrics_comparison.py` to create it
  - **Prerequisites check**:
    - [ ] Does `data/processed/songs_mapped_20k_balanced.csv` exist? (input dataset)
      - **Note**: The script looks for this specific file. If you have a different filename, update `DATASET_PATH` in `src/run_lyrics_comparison.py`
    - [ ] Does `models/new_song_mood_model.joblib` exist? (trained model)
      - **Note**: The script looks for this specific file. If you have a different filename, update `MODEL_PATH` in `src/run_lyrics_comparison.py`
    - [ ] Does the dataset have a lyrics column? (default: `text`)
      - **Note**: The script tries these column names in order: `text`, `lyrics`, `Lyrics`, `Text`, `song_text`
      - Check available columns: `python -c "import pandas as pd; df = pd.read_csv('data/processed/songs_mapped_20k_balanced.csv', nrows=1); print(list(df.columns))"`
- [ ] **Step 2**: Is API server running?
  - Check: `curl http://localhost:8000/api/health` (or open in browser)
  - Should return JSON: `{"status": "ok", "audio_model_loaded": true/false, "lyrics_model_loaded": true/false, "predictions_file_exists": true/false}`
  - **If not running**: Start with `python src/api_server.py`
- [ ] **Step 2**: Does `/api/stats` return data?
  - Check: `curl http://localhost:8000/api/stats` (or open in browser)
  - Should return JSON with `agreement`, `distribution`, `confusion`, `lowConfidence`, `confidenceDistribution`
  - **If error**: Check that `songs_with_predictions.csv` exists and has required columns (`audio_prediction`, `lyrics_prediction`)
- [ ] **Step 3**: Is inline script executing?
  - Check browser console for: `"DOM loaded, attempting to trigger API calls..."`
  - **If missing**: Check that `UI/app/layout.tsx` has the inline script (lines 42-179)
- [ ] **Step 3**: Is data being stored globally?
  - Check browser console: `window.__API_DATA__.stats`
  - Should show the stats object with `agreement`, `distribution`, `confusion`, etc.
  - **If null/undefined**: Check Network tab for failed API calls to `/api/stats`
- [ ] **Step 4**: Is React component mounting?
  - Check browser console for: `"ModelComparison: Component mounted on CLIENT"`
  - **If missing**: Component may not be rendering. Check React DevTools or component errors
- [ ] **Step 4**: Is listener being registered?
  - Check browser console for: `"ModelComparison: Registered API listener"`
  - **If missing**: Check that `window.__registerAPIListener__` exists: `typeof window.__registerAPIListener__`
- [ ] **Step 4**: Is data being received?
  - Check browser console for: `"ModelComparison: Received stats data:"` or `"ModelComparison: Found data in global store"`
  - **If missing**: Check that data exists in `window.__API_DATA__.stats` and events are firing
- [ ] **Step 4**: Is state being updated?
  - Check React DevTools: Component state should have `loading: false`, `agreementData` populated
  - **If not updating**: Check browser console for errors, verify data structure matches expected format
- [ ] **Step 5**: Are charts rendering?
  - Check DOM: Should see `<svg>` elements from Recharts
  - **If not rendering**: Check that `datasetDistribution`, `agreementData`, `confusionData` are populated (not empty arrays)

### **For Predict Endpoint:**
- [ ] **Step 1**: Is button click handler firing?
  - Check browser console for: `"PredictionInterface: Button clicked!"`
- [ ] **Step 2**: Is API call being made?
  - Check Network tab: Should see POST to `/api/predict`
- [ ] **Step 3**: Is song found in dataset?
  - Check API server console: Should see `"Found song '...' in dataset"`
- [ ] **Step 3**: Is model loaded?
  - Check: `curl http://localhost:8000/api/health` ‚Üí `"audio_model_loaded": true`
- [ ] **Step 3**: Is prediction successful?
  - Check API response in Network tab
- [ ] **Step 4**: Is response being processed?
  - Check browser console for: `"PredictionInterface: Making API call..."`
- [ ] **Step 5**: Is UI updating?
  - Check DOM: Should see prediction cards

---

## üêõ **COMMON ISSUES**

1. **CSV file not found**
   - **Symptom**: API returns 404 with "Predictions file not found"
   - **Fix**: Run `python src/run_lyrics_comparison.py` to generate `songs_with_predictions.csv`

2. **Model not loaded**
   - **Symptom**: API returns 500 with "Audio model not loaded"
   - **Fix**: Check `models/new_song_mood_model.joblib` exists

3. **CORS errors**
   - **Symptom**: Browser console shows CORS error
   - **Fix**: Already handled with `CORS(app)` in `api_server.py`

4. **React components not mounting**
   - **Symptom**: No component logs in console
   - **Fix**: Check `"use client"` directive, check for hydration errors

5. **Event listeners not firing**
   - **Symptom**: Data in global store but components not updating
   - **Fix**: Check if `useEffect` is running, check event listener registration

6. **State not updating**
   - **Symptom**: Data received but UI not changing
   - **Fix**: Check React DevTools for state values, check for re-render triggers

